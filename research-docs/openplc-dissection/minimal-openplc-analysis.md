# Minimal OpenPLC Analysis: Core Control Logic + Modbus Only

## Executive Summary

This analysis identifies what can be stripped from OpenPLC v3 to create a minimal working version with only core control logic and Modbus support. The goal is to create a clean foundation for implementing the decoupling architecture.

## Current Codebase Size Analysis

### Total OpenPLC v3 Codebase
- **Total source files:** 702 files (.cpp/.c)
- **Core runtime files:** 27 files
- **Core runtime size:** ~350KB of source code

### Core Files by Size (webserver/core/)
```
Essential Files (≤10KB):
- debug.cpp                   1,711 bytes  # Debug interface
- blank.cpp                   3,652 bytes  # Blank hardware layer
- client.cpp                  3,903 bytes  # Client utilities  
- main.cpp                    9,978 bytes  # Core control loop
- server.cpp                 10,440 bytes  # Network server

Modbus Files:
- modbus.cpp                 39,609 bytes  # Modbus TCP server
- modbus_master.cpp          29,312 bytes  # Modbus master/client

Removable Protocol Files:
- dnp3.cpp                   16,557 bytes  # DNP3 protocol
- enip.cpp                   24,389 bytes  # EtherNet/IP protocol  
- pccc.cpp                   24,678 bytes  # PCCC protocol

Removable Infrastructure:
- interactive_server.cpp     19,420 bytes  # Web interface server
- persistent_storage.cpp      9,613 bytes  # Persistent storage
- utils.cpp                   8,319 bytes  # Utility functions

Hardware Layers (ALL REMOVABLE - 16 files):
- Total size: ~200KB across various hardware platforms
```

## Essential Components for Minimal OpenPLC

### 1. Absolute Core Requirements

#### Core Runtime Files (MUST KEEP)
```cpp
webserver/core/
├── main.cpp              # Control loop and initialization 
├── ladder.h              # Core data structures and prototypes
├── server.cpp            # Generic network server (for Modbus)
├── modbus.cpp            # Modbus TCP server implementation
├── modbus_master.cpp     # Modbus master functionality (optional)
├── utils.cpp             # Essential utility functions only
└── lib/                  # IEC 61131-3 runtime library
    ├── iec_types.h
    ├── iec_std_lib.h  
    ├── iec_std_FB.h
    └── iec_std_functions.h
```

#### Generated Code Files (MUST BE GENERATED)
```cpp
# These are created by compilation process:
├── glueVars.cpp          # Variable binding (generated by glue_generator)
├── LOCATED_VARIABLES.h   # IEC program variables (generated by matiec)
├── config.cpp/.h         # PLC program logic (generated by matiec)
```

#### Hardware Layer (SIMPLIFIED)
```cpp
hardware_layers/
└── blank.cpp             # Minimal hardware abstraction (3.6KB)
```

### 2. Core Control Loop Dependencies

**Essential Functions in main.cpp:**
```cpp
// Line 87: Initialize PLC program
config_init__();

// Line 88: Bind variables to I/O buffers  
glueVars();

// Line 205: Execute PLC program logic (CORE FUNCTION)
config_run__(__tick++);

// Hardware abstraction calls
updateBuffersIn();   // Read inputs
updateBuffersOut();  // Write outputs

// Modbus integration (if keeping Modbus)
updateBuffersIn_MB();  # Read from Modbus slaves
updateBuffersOut_MB(); # Write to Modbus slaves
```

### 3. Modbus Integration (KEEP or REMOVE)

**Option A: Keep Modbus (Recommended)**
- Keep: `modbus.cpp` (39KB) - Modbus TCP server
- Optional: `modbus_master.cpp` (29KB) - for Modbus master functionality
- Requires: `server.cpp` for network infrastructure

**Option B: Remove Modbus (Ultra-minimal)**
- Remove all Modbus files
- Remove network server infrastructure
- Result: Pure control logic only (~25KB core)

## Detailed Removal Analysis

### 1. Removable Protocol Implementations (Save ~95KB)

#### DNP3 Protocol (`dnp3.cpp` - 16.5KB)
**Removal Impact:** LOW
- Self-contained protocol implementation
- No dependencies on core control logic
- Remove from `interactive_server.cpp`
```cpp
// Remove these lines from interactive_server.cpp:
bool run_dnp3 = 0;           // Line 49
pthread_t dnp3_thread;       // Line 63  
void *dnp3Thread(void *arg)  // Lines 84-87
pthread_create(&dnp3_thread, NULL, dnp3Thread, NULL); // Line 379
```

#### EtherNet/IP Protocol (`enip.cpp` - 24.4KB)
**Removal Impact:** LOW
- Self-contained implementation
- Remove from `interactive_server.cpp` and `server.cpp`
```cpp
// Remove from ladder.h:
#define ENIP_PROTOCOL       2

// Remove from server.cpp message dispatcher
```

#### PCCC Protocol (`pccc.cpp` - 24.7KB)
**Removal Impact:** LOW
- Allen-Bradley protocol support
- Self-contained implementation

### 2. Removable Infrastructure Components (Save ~37KB)

#### Interactive Server (`interactive_server.cpp` - 19.4KB)
**Removal Impact:** MEDIUM
- Web interface communication
- Protocol management and configuration
- **Dependencies:** Main thread creation in `main.cpp:86`

**Removal Steps:**
```cpp
// main.cpp changes needed:
// Comment out line 86:
// pthread_create(&interactive_thread, NULL, interactiveServerThread, NULL);

// Remove from ladder.h:
extern bool run_modbus;
extern bool run_dnp3;
extern bool run_enip;
extern bool run_pstorage;
```

#### Persistent Storage (`persistent_storage.cpp` - 9.6KB)
**Removal Impact:** LOW
- Database storage functionality
- Self-contained module

#### Client Utilities (`client.cpp` - 3.9KB)  
**Removal Impact:** LOW
- Client-side communication utilities
- Not used by core control loop

### 3. Hardware Layer Simplification (Save ~200KB)

#### Current Hardware Layers (ALL REMOVABLE)
```
hardware_layers/
├── blank.cpp           3,652 bytes   # KEEP (minimal implementation)
├── raspberrypi.cpp     5,235 bytes   # REMOVE
├── pixtend.cpp        23,689 bytes   # REMOVE  
├── sequent.cpp        38,354 bytes   # REMOVE
├── unipi.cpp           7,900 bytes   # REMOVE
├── neuron.cpp         11,907 bytes   # REMOVE
├── [12 other platforms...]          # REMOVE ALL
```

**Keep Only:** `blank.cpp` (3.6KB) - provides minimal hardware abstraction
**Remove:** All platform-specific implementations

### 4. Utility Function Analysis (`utils.cpp` - 8.3KB)

#### Essential Functions (KEEP)
```cpp
void sleep_until()        # Timing control for control loop
void timespec_diff()      # Performance measurement  
void log()                # Basic logging
void handleSpecialFunctions() # IEC 61131-3 special functions
void updateTime()         # System time updates
```

#### Removable Functions (REMOVE ~50% of file)
```cpp
void *interactiveServerThread()  # Interactive server support
void disableOutputs()            # Shutdown procedures
void RecordCycletimeLatency()    # Performance monitoring
// Various web interface functions
```

### 5. Library Dependencies Analysis

#### Essential Libraries (MUST KEEP)
```cpp
webserver/core/lib/
├── iec_types.h           # IEC 61131-3 data types
├── iec_std_lib.h         # Standard library functions
├── iec_std_FB.h          # Function blocks
└── iec_std_functions.h   # Standard functions
```

#### External Dependencies (CONDITIONAL)
```cpp
utils/libmodbus_src/      # Only needed if keeping Modbus
utils/matiec_src/         # IEC compiler (needed for compilation)
utils/glue_generator_src/ # Variable binding (needed for compilation)
```

## Minimal OpenPLC Configurations

### Configuration 1: Core + Modbus (Recommended)
**Size:** ~80KB source code
**Files:** 8 core files + Modbus support
```cpp
Essential Files:
- main.cpp (simplified)           ~8KB
- ladder.h                        ~4KB  
- server.cpp                      ~10KB
- modbus.cpp                      ~40KB
- modbus_master.cpp (optional)    ~29KB
- utils.cpp (trimmed)             ~4KB
- hardware_layers/blank.cpp       ~4KB
- lib/ (IEC runtime)              ~15KB
```

### Configuration 2: Ultra-minimal Core Only  
**Size:** ~25KB source code
**Files:** 4 core files only
```cpp
Ultra-minimal:
- main.cpp (no network)           ~6KB
- ladder.h (no protocols)         ~3KB
- utils.cpp (core functions only) ~2KB  
- hardware_layers/blank.cpp       ~4KB
- lib/ (IEC runtime)              ~15KB
```

## Implementation Steps for Minimal Branch

### Phase 1: Remove Protocol Implementations
1. **Delete files:**
   ```bash
   rm webserver/core/dnp3.cpp
   rm webserver/core/enip.cpp  
   rm webserver/core/pccc.cpp
   rm webserver/core/persistent_storage.cpp
   rm webserver/core/client.cpp
   ```

2. **Update ladder.h:**
   ```cpp
   // Remove protocol definitions:
   // #define DNP3_PROTOCOL       1
   // #define ENIP_PROTOCOL       2
   
   // Remove protocol function declarations:
   // void dnp3StartServer(int port);
   // int processEnipMessage(...);
   // uint16_t processPCCCMessage(...);
   ```

### Phase 2: Remove Hardware Layers
1. **Keep only blank.cpp:**
   ```bash
   cd webserver/core/hardware_layers/
   ls | grep -v blank.cpp | xargs rm
   ```

2. **Update build system to only compile blank.cpp**

### Phase 3: Simplify Interactive Server
**Option A:** Remove completely
```bash
rm webserver/core/interactive_server.cpp
```

**Option B:** Simplify to basic Modbus-only server
- Remove DNP3/EtherNet/IP/PCCC thread creation
- Remove web interface commands  
- Keep only Modbus thread management

### Phase 4: Clean Up Main Control Loop
```cpp
// main.cpp simplifications:

// Remove interactive server thread
// pthread_create(&interactive_thread, NULL, interactiveServerThread, NULL);

// Simplify control loop to only:
while (run_openplc) {
    pthread_mutex_lock(&bufferLock);
    updateBuffersIn();                    // Hardware inputs
    updateBuffersIn_MB();                 // Modbus inputs (if keeping)
    config_run__(__tick++);              // PLC logic execution  
    updateBuffersOut_MB();               // Modbus outputs (if keeping)
    updateBuffersOut();                  // Hardware outputs
    pthread_mutex_unlock(&bufferLock);
    sleep_until(&timer_start, common_ticktime__);
}
```

### Phase 5: Trim Utility Functions
```cpp
// Keep only essential functions in utils.cpp:
void sleep_until()
void timespec_diff()  
void log()
void handleSpecialFunctions()
void updateTime()

// Remove all interactive server and web interface functions
```

## Expected Results

### Minimal OpenPLC Metrics
- **Source files:** 8 files (vs. 27 original)
- **Code size:** ~80KB (vs. ~350KB original)  
- **Protocols:** Modbus TCP only (vs. 4 protocols)
- **Hardware support:** Blank/generic only (vs. 16 platforms)
- **Features removed:** Web interface, persistent storage, debug interface
- **Memory footprint:** ~70% reduction
- **Compilation time:** ~80% reduction

### Preserved Functionality
- ✅ Full IEC 61131-3 program execution
- ✅ Core control loop timing and performance
- ✅ Modbus TCP server (read/write all data types)
- ✅ Modbus master functionality (optional)
- ✅ Basic logging and error handling
- ✅ Hardware abstraction layer (generic)

### Removed Functionality  
- ❌ Web interface and configuration
- ❌ DNP3, EtherNet/IP, PCCC protocols
- ❌ Platform-specific hardware support
- ❌ Interactive debugging features
- ❌ Persistent storage and database
- ❌ Advanced monitoring and statistics

## Benefits for Decoupling Project

1. **Clean Foundation:** Minimal codebase easier to refactor
2. **Focused Scope:** Only Modbus protocol needs decoupling treatment
3. **Reduced Complexity:** Fewer interdependencies to manage
4. **Faster Development:** Smaller codebase for faster iteration
5. **Clear Testing:** Single protocol validation vs. multiple protocols
6. **Educational Value:** Clean example of core PLC functionality

This minimal version provides an excellent foundation for implementing the protocol decoupling architecture with significantly reduced complexity and risk.